<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <PackageIntermediatePath Condition="'$(PackageIntermediatePath)'==''">$(IntermediateOutputPath)Package</PackageIntermediatePath>
        <_OutputPackage>$(MSBuildProjectDirectory)\$(OutDir)\%(Spec.Filename).nupkg</_OutputPackage>
    </PropertyGroup>
	<Target Name="Package" Inputs="@(Content);@(IntermediateAssembly)" Outputs="@(_OutputPackage">
		<RemoveDir Directories="$(PackageIntermediatePath)" Condition="Exists('$(PackageIntermediatePath)')" />
		<MakeDir Directories="$(PackageIntermediatePath)" />
        <Copy SourceFiles="@(IntermediateAssembly)" DestinationFolder="$(PackageIntermediatePath)" />
		<Copy SourceFiles="@(Content)" DestinationFolder="$(PackageIntermediatePath)" />
        <Exec Command="&quot;$(MSBuildThisFileDirectory)\NuGet.exe&quot; pack &quot;@(Spec->'%(FullPath)')&quot; -b &quot;$(MSBuildProjectDirectory)\$(PackageIntermediatePath)&quot; -o &quot;$(MSBuildProjectDirectory)\$(OutDir.TrimEnd('\'))&quot;" />
	</Target>
	
	<Target Name="CleanPackage">
		<ItemGroup>
			<_Del Include="$(MSBuildProjectDirectory)\$(OutDir)\%(Spec.FileName).nupkg" />
		</ItemGroup>
		<Delete Files="@(_Del)" />
		<RemoveDir Directories="$(PackageIntermediatePath)" />
	</Target>

    <PropertyGroup>
        <CoreBuildDependsOn>$(CoreBuildDependsOn);Package</CoreBuildDependsOn>
        <CoreCleanDependsOn>$(CoreCleanDependsOn);CleanPackage</CoreCleanDependsOn>
    </PropertyGroup>
</Project>